<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
<title>DynamoRIO: Debugging</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_debugging.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Debugging </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md137"></a>
General Tips</h1>
<ul>
<li>Use debug builds (pass "-debug" to drrun) with notifications turned on to diagnose errors. In general, it is much easier to debug with the debug build of DynamoRIO. A release build crash may show up as an earlier, easier-to-diagnose assert in debug build.</li>
<li>Try running without any client to isolate where the error is</li>
<li>Asserts can be suppressed with the <code>-ignore_assert_list *</code> option or with <code>-checklevel 0</code>.</li>
<li>Logging can be enabled with <code>-loglevel N</code>. Logs are written to DR-install/logs/. See <a class="el" href="page_logging.html">our logging documentation</a> for information on what is contained in the logs.</li>
<li><p class="startli">Use the load_syms or load_syms64 script to locate client and private libraries on Windows (<code>-no_hide</code> is no longer necessary (it never helped with the client library anyway)). Pre-install these are in tools/windbg-scripts/load_syms and tools/windbg-scripts/load_syms64. I simply change my windbg shortcuts to point at these via -c (please note: these are meant for <em>attaching</em> to a running process that is under DynamoRIO control): </p><div class="fragment"><div class="line"><span class="stringliteral">&quot;C:\Program Files (x86)\Debugging Tools for Windows\windbg.exe&quot;</span> -pt 1 -c <span class="stringliteral">&quot;$&gt;&lt;E:\derek\dr\git\src\tools\windbg-scripts\load_syms&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="stringliteral">&quot;C:\Program Files\Debugging Tools for Windows (x64)\windbg.exe&quot;</span> -pt 1 -c <span class="stringliteral">&quot;$&gt;&lt;E:\derek\dr\git\src\tools\windbg-scripts\load_syms64&quot;</span></div>
</div><!-- fragment --><p class="startli">For debugging a 32-bit process with the 64-bit windbg, use the load_symsWOW64 variant. However, this is less well-tested than using a 32-bit windbg on a 32-bit process.</p>
</li>
<li>To locate client and private libraries on Linux, use the add-symbol-file commands printed out at start time (see below for more information).</li>
<li>Use read watchpoints instead of breakpoints in application code, as the trap instruction inserted by the debugger into the application code can end up copied into DynamoRIO's code cache, resulting in an unhandled trap.</li>
<li>On Windows, if an application invokes OutputDebugString() while under a debugger, DynamoRIO can end up losing control of the application.</li>
<li>A SIGSEGV or Access Violation observed in a debugger does not necessarily indicate a problem. DynamoRIO uses "safe read" operations to access untrusted application addresses and can incur faults which are handled and continued past.</li>
<li>DynamoRIO disables itself when Windows is booted in safe mode (without networking). Thus, if a crash occurs in a Windows service under DynamoRIO, rebooting in safe mode will allow recovery.</li>
<li><p class="startli">If a client library doesn't seem to function for a given process, it is possible that the client library wasn't loaded due to permissions errors.</p>
<p class="startli">One of the common situations where this happens is when the target application runs as a different user than the user who created the client library. This results in the application process not having the right permissions to access the client library.</p>
<p class="startli">Try running the process under the debug mode of DynamoRIO (see <a class="el" href="dr__config_8h.html#a10d7c5dbc9a055fa6c18bf3f2a6eea46">dr_register_process()</a>), where diagnostic messages are raised on errors like client library permissions. To see all messages, set the notification options like -msgbox_mask and -stderr_mask options to 0xf (see <a class="el" href="page_deploy.html#sec_options">DynamoRIO Runtime Options</a>). This will alert you to the problem.</p>
</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md139"></a>
Debugging On Linux</h1>
<p>On Linux we use gdb for debugging. Note that we now use debug information files that are separate from their corresponding shared libraries: e.g., <code>libdynamorio.so</code> and <code>libdynamorio.so.debug</code>. There is a section inside the shared library that identifies the debug file.</p>
<h2><a class="anchor" id="autotoc_md140"></a>
Expected Signals</h2>
<p>On Linux, DR sends itself a SIGILL signal during initialization, in order to measure the size of the signal frame used by the kernel. If you are under gdb, simply continue past this signal.</p>
<p>Additionally, DR uses various "safe read" strategies where it may raise a SIGSEGV or SIGBUS while examining application memory. Load symbols and look for <code>safe_read</code> variants on the call stack (such as <code>safe_read_tls_magic</code>, <code>safe_read_asm_pre</code>, <code>safe_read_fast</code>) to identify these. Just like with the init-time SIGILL, simply continue past these.</p>
<p>One final signal used by DR is SIGUSR2, which is sent to other threads to suspend or terminate them.</p>
<h2><a class="anchor" id="autotoc_md141"></a>
Attaching</h2>
<p>Use the DynamoRIO runtime option <code>-msgbox_mask</code> with a desired mask, optionally along with <code>-pause_via_loop</code> if the application uses stdin, to cause a target application to wait and let you attach gdb. To attach early on, use a debug internal build and set the mask for informational messages. See the option descriptions in the API documentation.</p>
<h2><a class="anchor" id="autotoc_md142"></a>
Launching From GDB</h2>
<p>For fast iterative debugging of small applications, it's nice to be able to launch the app under DR under gdb with one command:</p>
<div class="fragment"><div class="line">$ gdb --args bin64/drrun -ops... -- ./path/to/myapp</div>
</div><!-- fragment --><p>However, be sure to run this command within gdb prior to running the app to ensure success:</p>
<div class="fragment"><div class="line">set disable-randomization off</div>
</div><!-- fragment --><p>One drawback over attaching is that gdb's breakpoints in the loader can interfere with the dlopen() execution, and you will have to continue through them. DR's safe_read faults may also show up. It's best to ignore them via:</p>
<div class="fragment"><div class="line">handle SIGSEGV nostop pass</div>
<div class="line">handle SIGBUS nostop pass</div>
</div><!-- fragment --><p>If you have control of the target application you can build it with the start/stop interface so that it invokes DynamoRIO and then run it under gdb just like a native application.</p>
<h2><a class="anchor" id="autotoc_md143"></a>
Loading Client Symbols</h2>
<p>To isolate clients and their libraries from the application, DR uses its own private loader to load clients. By default, gdb can only see libraries loaded by the glibc loader (ld-linux.so). To work around this problem, DR prints the gdb commands necessary to load symbols in a debug build. It looks like this:</p>
<div class="fragment"><div class="line">&lt;Starting application /usr/local/google/home/rnk/dynamorio/build/suite/tests/bin/client.events (10801)&gt;</div>
<div class="line">&lt;Paste into GDB to debug DynamoRIO clients:</div>
<div class="line">set confirm off</div>
<div class="line">add-symbol-file <span class="stringliteral">&#39;/home/user/dr/suite/tests/bin/libclient.events.dll.so&#39;</span> 0x00007f14e46143e0</div>
<div class="line">add-symbol-file <span class="stringliteral">&#39;/home/user/dr/lib64/debug/libdynamorio.so&#39;</span> 0x00007f152865c000</div>
<div class="line">add-symbol-file <span class="stringliteral">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span> 0x00007f1528280320</div>
<div class="line">add-symbol-file <span class="stringliteral">&#39;/lib64/ld-linux-x86-64.so.2&#39;</span> 0x00007f15285b6090</div>
<div class="line">&gt;</div>
</div><!-- fragment --><p>In a release build, that message is not printed. However, the same string of commands is available in the global variable <code>gdb_priv_cmds</code>, which can be displayed within gdb with something like this:</p>
<div class="fragment"><div class="line">x/3s gdb_priv_cmds</div>
</div><!-- fragment --><p>You can also use the <code>-no_private_loader</code> option to use the system loader to load the client, although this will break many clients and apps and is no longer officially supported.</p>
<p>To manually generate the symbol file loading commands, you want to tell gdb where the <code>.text</code> segment is. </p><div class="fragment"><div class="line">echo add-symbol-file <span class="stringliteral">&#39;/home/user/dr/lib64/debug/libdynamorio.so&#39;</span>  0x$(objdump -h /home/user/dr/lib64/debug/libdynamorio.so | grep text | awk <span class="stringliteral">&#39;{print $4}&#39;</span>)</div>
</div><!-- fragment --><p>You will need to adjust that address based on where the library was actually loaded: simply add the current base address from the maps file or DR's diagnostic printout and subtract the preferred base.</p>
<h2><a class="anchor" id="autotoc_md144"></a>
Loading DynamoRIO Symbols</h2>
<p>The <code>add-symbol-file</code> commands shown in the prior section include symbols for the DynamoRIO library. If you need symbols for the DR library itself before DR sets up those commands, in some cases the debugger loads them properly for you and you do not need to do anything special. However, some versions of gdb load DR's symbols at the wrong address when you launch a process from within the debugger and you may need to clear the symbols first, before executing any <code>add-symbol-file ...</code> commands, by running: </p><div class="fragment"><div class="line">symbol-file</div>
</div><!-- fragment --><p>The debugger also gets DR's symbols wrong when DR reloads itself to avoid gaps between its segments. The repository contains <a href="https://github.com/DynamoRIO/dynamorio/blob/master/tools/gdb-scripts/gdb-drsymload.py">a gdb python script to load the libdynamorio.so symbols</a> which is the simplest way to automagically get the correct symbols.</p>
<h2><a class="anchor" id="autotoc_md145"></a>
Memory Querying</h2>
<p>Another useful script provided in the repository is a <a href="https://github.com/DynamoRIO/dynamorio/blob/master/tools/gdb-scripts/gdb-memquery.py">memory query script to print the line in the maps file matching a given address</a>.</p>
<div class="fragment"><div class="line">(gdb) memquery $rsp</div>
<div class="line">7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md146"></a>
Call Stacks</h2>
<p>gdb has trouble with generating call stacks at various points during DR execution, such as when at a system call in generated code. Manually setting the stack and frame pointers can solve this:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># optional args: $arg0=frame count, $arg1=start frame ptr</span></div>
<div class="line">define setbt</div>
<div class="line">  <span class="keywordflow">if</span> $argc &lt; 1</div>
<div class="line">    set var $max=5</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    set var $max=$arg0</div>
<div class="line">  end</div>
<div class="line">  <span class="keywordflow">if</span> $argc &lt; 2</div>
<div class="line">    set var $myfp=$ebp</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    set var $myfp=$arg1</div>
<div class="line">  end</div>
<div class="line">  set var $count=0</div>
<div class="line">  <span class="keywordflow">while</span> $count &lt; $max &amp;&amp; $myfp != 0</div>
<div class="line">    <span class="keywordflow">if</span> $count == 1</div>
<div class="line">      set var $esp = $myfp</div>
<div class="line">    end</div>
<div class="line">    <span class="keywordflow">if</span> $count == 2</div>
<div class="line">      set var $ebp = $myfp</div>
<div class="line">    end</div>
<div class="line">    printf <span class="stringliteral">&quot;\nframe %d\n&quot;</span>, $count</div>
<div class="line">    x/4dx $myfp</div>
<div class="line">    info line * *((<span class="keywordtype">long</span>*)($myfp+<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)))</div>
<div class="line">    x/2i *((<span class="keywordtype">long</span>*)($myfp+sizeof(<span class="keywordtype">long</span>)))</div>
<div class="line">    set var $myfp=*((<span class="keywordtype">long</span> *)$myfp)</div>
<div class="line">    set var $count=$count+1</div>
<div class="line">  end</div>
<div class="line">  bt</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># optional args: $arg0=frame count, $arg1=start frame ptr</span></div>
<div class="line">define setbt64</div>
<div class="line">  <span class="keywordflow">if</span> $argc &lt; 1</div>
<div class="line">    set var $max=5</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    set var $max=$arg0</div>
<div class="line">  end</div>
<div class="line">  <span class="keywordflow">if</span> $argc &lt; 2</div>
<div class="line">    set var $myfp=$rbp</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    set var $myfp=$arg1</div>
<div class="line">  end</div>
<div class="line">  set var $count=0</div>
<div class="line">  <span class="keywordflow">while</span> $count &lt; $max &amp;&amp; $myfp != 0</div>
<div class="line">    <span class="keywordflow">if</span> $count == 1</div>
<div class="line">      set var $rsp = $myfp</div>
<div class="line">    end</div>
<div class="line">    <span class="keywordflow">if</span> $count == 2</div>
<div class="line">      set var $rbp = $myfp</div>
<div class="line">    end</div>
<div class="line">    printf <span class="stringliteral">&quot;\nframe %d\n&quot;</span>, $count</div>
<div class="line">    x/4gx $myfp</div>
<div class="line">    info line * *((<span class="keywordtype">long</span>*)($myfp+<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)))</div>
<div class="line">    x/2i *((<span class="keywordtype">long</span>*)($myfp+sizeof(<span class="keywordtype">long</span>)))</div>
<div class="line">    set var $myfp=*((<span class="keywordtype">long</span> *)$myfp)</div>
<div class="line">    set var $count=$count+1</div>
<div class="line">  end</div>
<div class="line">  bt</div>
<div class="line">end</div>
</div><!-- fragment --><p>For examining the stack, I find this function useful: </p><div class="fragment"><div class="line"><span class="preprocessor"># Equivalent to windbg&#39;s dps command.</span></div>
<div class="line"><span class="preprocessor"># Pass it the stack pointer range: [start, end)</span></div>
<div class="line">define dps</div>
<div class="line">  set var $start = (<span class="keywordtype">char</span> *) $arg0</div>
<div class="line">  set var $end = (<span class="keywordtype">char</span> *) $arg1</div>
<div class="line">  set var $ptr = $start</div>
<div class="line">  <span class="keywordflow">while</span> $ptr &lt; $end</div>
<div class="line">    set var $retaddr = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)$ptr)</div>
<div class="line"><span class="preprocessor">    # I don&#39;t like how %p prints &quot;(nil)&quot; so:</span></div>
<div class="line">    <span class="keywordflow">if</span> <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*) == 8</div>
<div class="line">      printf <span class="stringliteral">&quot;0x%016lx  0x%016lx  &quot;</span>, $ptr, $retaddr</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      printf <span class="stringliteral">&quot;0x%08x  0x%08x  &quot;</span>, $ptr, $retaddr</div>
<div class="line">    end</div>
<div class="line">    # We have to cast to <span class="keywordtype">void</span>* to avoid gdb failing to properly evaluate</div>
<div class="line">    # $retaddr (ends up <span class="keyword">using</span> value from 1st iter on each iter).</div>
<div class="line">    #</div>
<div class="line"><span class="preprocessor">    # XXX: can we get the result of this into a var and not print it</span></div>
<div class="line"><span class="preprocessor">    # if it says &quot;No symbol matches...&quot;?</span></div>
<div class="line">    info symbol (<span class="keywordtype">void</span> *)$retaddr</div>
<div class="line">    set var $ptr = $ptr + <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*)</div>
<div class="line">  end</div>
<div class="line">end</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md147"></a>
Switching Stacks</h2>
<p>The <code>frame</code> command has never worked for me: it always prints <code>#0 0x00000000 in ?? ()</code>. Instead I set <code>$ebp</code>, and sometimes have to also set <code>$esp</code> and <code>$eip</code> (which can only be set from frame 0). Or you can manually walk frame pointers:</p>
<div class="fragment"><div class="line">(gdb) info symbol **(sc-&gt;ebp+4)</div>
<div class="line">get_memory_info + 647 in section .text</div>
<div class="line">(gdb) info symbol **(**(sc-&gt;ebp)+4)</div>
<div class="line">check_thread_vm_area + 7012 in section .text</div>
<div class="line">(gdb) info symbol **(**(**(sc-&gt;ebp))+4)</div>
<div class="line">check_new_page_start + 79 in section .text</div>
<div class="line">(gdb) info symbol **(**(**(**(sc-&gt;ebp)))+4)</div>
<div class="line">build_bb_ilist + 514 in section .text</div>
</div><!-- fragment --><p>To get line numbers use <code>info line</code> instead:</p>
<div class="fragment"><div class="line">info line **(**(sc-&gt;ebp+4))</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md148"></a>
Viewing Segment Bases</h2>
<p>There is no way to view segment bases directly within gdb, but you can create a core file and mine it to find the bases. Here is how to do it for gs for 64-bit stored in its MSR (rather than the GDT):</p>
<div class="fragment"><div class="line">$ sudo apt-get install elfutils</div>
<div class="line">...</div>
<div class="line">(gdb) thread 3</div>
<div class="line">[Switching to thread 3 (Thread 0x7ffdf2af5700 (LWP 1166202))]</div>
<div class="line">(gdb) generate-core-file mycore</div>
<div class="line">Saved corefile mycore</div>
<div class="line">(gdb) shell eu-readelf --notes mycore | grep -A 12 <span class="stringliteral">&#39;pid: 1166202&#39;</span> | grep gs\.base</div>
<div class="line">    fs.base:   0x00007ffdf2af5700  gs.base:   0x00007ffdf2af1000</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md150"></a>
Debugging On Windows</h1>
<h2><a class="anchor" id="autotoc_md151"></a>
Debugging Tools</h2>
<p>The Visual Studio debugger is completely inadequate for debugging applications running under DynamoRIO. It frequently fails due to our manipulation of its injected thread, it has no command-line interface, etc. We use WinDbg (and its counterparts ntsd and cdb) exclusively. WinDbg is a low-level debugger that provides symbolic debugging too.</p>
<p>Install the Debugging Tools for Windows to get the full WinDbg. For debugging 32-bit applications, we recommend using WinDbg version 6.3.0017, <em>not</em> the newer versions 6.4 through 6.11, as they have problems displaying callstacks involving DynamoRIO code. However, if you cannot obtain 6.3.0017 (it is no longer supported), get the latest version. You'll have to go to extra effort to get a callstack when attaching at a DynamoRIO messagebox midway through execution for a 32-bit process (see below). For 64-bit, use the most recent version of WinDbg.</p>
<p>Most of the information about how to use this WinDbg is available from its excellent help file. Some key commands include:</p>
<ul>
<li>Display callstacks of all threads: <code>~**kb</code></li>
<li>Select thread number N: <code>~Ns</code></li>
<li>Display callstack of current thread with numbered frames: <code>kn</code></li>
<li>Select frame number N: <code>.frame N</code></li>
<li>Display local variables (only useful in debug builds): <code>dv</code></li>
<li>Display local variable x: <code>dt x</code></li>
<li>Display all symbols in module M starting with XYZ: <code>x M!XYZ**</code></li>
<li>Display stack with symbolic references: <code>dds esp</code></li>
<li>Switch context (e.g., to an exception context): <code>.cxr &lt;CONTEXT address&gt;</code></li>
<li>Display loaded modules: <code>lm</code></li>
<li>Open a log file: <code>.logopen &lt;filename&gt;</code></li>
<li>Set a breakpoint: <code>bp &lt;address&gt;</code></li>
<li>Continue execution: <code>g</code></li>
</ul>
<p>See the <code>tools/windbg-scripts</code> scripts and the WindDbg Tips section below for further examples.</p>
<p>You also need access to the symbol files both for DynamoRIO and for the operating system libraries. You can use the <code>.symfix</code> command to automatically download symbols from the Microsoft symbol server. You should specify a local cache directory so that WinDbg doesn't query the server every time: <code>.symfix c:\my\symbol\dir</code>. The symbol path and cache directory are stored in a global environment variable <code>_NT_SYMBOL_PATH</code>. Here is an example path:</p>
<div class="fragment"><div class="line">c:\build12012\release;srv*c:\symbols*http:<span class="comment">//msdl.microsoft.com/download/symbols</span></div>
</div><!-- fragment --><p>Note that you may want to remove any network paths once you have the symbols of interest locally to speed up debugging.</p>
<h2><a class="anchor" id="autotoc_md152"></a>
Attaching</h2>
<p>To attach to a process on Windows, use the <code>-msgbox_mask</code> option and attach the debugger while the dialog box has paused the application. Use <code>-msgbox_mask 15</code> to attach a program startup, or <code>-msgbox_mask 12</code> to attach at a later error.</p>
<p>In order to attach press <code>F6</code>; this will show a list of all processes available and you can choose your application. You can also view the attach list through the File-&gt;Attach menu item. After you have attached click 'ok' on the pop up window.</p>
<h2><a class="anchor" id="autotoc_md153"></a>
Launching Within WinDbg</h2>
<p>To get control of DynamoRIO when it starts initializing, invoke WinDbg from the cygwin command line as follows. Make sure WinDbg is in your path.</p>
<div class="fragment"><div class="line">% windbg bin32/drrun.exe -- c:\\path\\to\\targetapp.exe</div>
</div><!-- fragment --><p>Once the debugger command line comes up, type the following commands, substituting your path to the directory where dynamorio.dll is located:</p>
<div class="fragment"><div class="line">&gt; .childdbg 1</div>
<div class="line">&gt; bp drinjectlib!inject_gencode_mapped_helper</div>
<div class="line">&gt; g</div>
<div class="line">&gt; gu</div>
<div class="line">&gt; r $t0=poi(map)</div>
<div class="line">&gt; g</div>
<div class="line">&gt; .sympath c:\mybuild\lib32\debug</div>
<div class="line">&gt; .reload dynamorio.dll=@$t0</div>
<div class="line">&gt; bp dynamorio!dynamorio_earliest_init_takeover</div>
<div class="line">&gt; g</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md154"></a>
Automatically loading symbols</h2>
<p>The dynamorio.dll library is not loaded by the system loader, and so WinDbg does not automatically find it. Once DynamoRIO has initialized enough, a script that we provide will automatically load the symbols for DynamoRIO and all client libraries in use. See the top of this file for how to load these scripts at WinDbg startup. From within WinDbg, for 32-bit:</p>
<div class="fragment"><div class="line">$&gt;&lt;c:\path\to\dynamorio\sources\tools\windbg-scripts\load_syms</div>
</div><!-- fragment --><p>For 64-bit:</p>
<div class="fragment"><div class="line">$&gt;&lt;c:\path\to\dynamorio\sources\tools\windbg-scripts\load_syms64</div>
</div><!-- fragment --><p>For a 32-bit application but a 64-bit windbg:</p>
<div class="fragment"><div class="line">$&gt;&lt;c:\path\to\dynamorio\sources\tools\windbg-scripts\load_symsWOW64</div>
</div><!-- fragment --><p>These scripts will fail if the process is not running under DynamoRIO or if it has not finished DynamoRIO initialization: thus, they will not work at the early attach point described under Launching Within WinDbg above.</p>
<p>To manually point WinDbg at the library, you will need its directory and its base address. Then use these two commands:</p>
<div class="fragment"><div class="line">&gt; .sympath c:\path\to\lib32\debug</div>
<div class="line">&gt; .reload dynamorio.dll=15000000</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md155"></a>
Private Libraries</h2>
<p>Libraries loaded for a client are not on the system library list. To identify these modules use the following command:</p>
<div class="fragment"><div class="line">!list -t dynamorio!privmod_t.next -x <span class="stringliteral">&quot;dt&quot;</span> -a <span class="stringliteral">&quot;dynamorio!privmod_t&quot;</span> @@(dynamorio!modlist)</div>
</div><!-- fragment --><p>Symbols for private libraries can be automatically loaded using the load_syms script. For 32-bit:</p>
<div class="fragment"><div class="line">$&gt;&lt;c:\path\to\dynamorio\sources\tools\windbg-scripts\load_syms</div>
</div><!-- fragment --><p>For 64-bit:</p>
<div class="fragment"><div class="line">$&gt;&lt;c:\path\to\dynamorio\sources\tools\windbg-scripts\load_syms64</div>
</div><!-- fragment --><p>For a 32-bit application but a 64-bit windbg:</p>
<div class="fragment"><div class="line">$&gt;&lt;c:\path\to\dynamorio\sources\tools\windbg-scripts\load_symsWOW64</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md156"></a>
32-bit DynamoRIO Callstacks with WinDbg 6.4+</h2>
<p>Windbg versions from 6.4 onward refuse to show a callstack if it's not part of the main stack for that thread, for 32-bit processes. You'll see just the top frame, often <code>ntdll!NtRaiseHardError</code> if you attached at a message box. Something like this should show the right callstack although it won't let you examine frames:</p>
<div class="fragment"><div class="line">knÂ =esp esp eip</div>
</div><!-- fragment --><p>Another trick is to clobber the TEB stack fields:</p>
<div class="fragment"><div class="line">$&gt;&lt;c:\path\to\dynamorio\sources\tools\windbg-scripts\load_syms</div>
<div class="line">!teb</div>
<div class="line">r $t0=poi(dynamorio!tls_dcontext_offs)</div>
<div class="line">r $t0=poi(fs:@$t0)</div>
<div class="line">ed @$teb+4 @@(((dynamorio!dcontext_t*)@$t0)-&gt;dstack)</div>
<div class="line">ed @$teb+8 @@(((dynamorio!dcontext_t*)@$t0)-&gt;dstack - dynamorio!dynamo_options.stack_size)</div>
<div class="line">kn</div>
</div><!-- fragment --><p>Which will then result in the k commands working nicely (I've done this in 6.11.001.402; should work in all other versions). &#160;Though of course only do this when not planning to continue app execution, or restore the TEB fields, just in case (that's what the <code>!teb</code> is for, to print out the original values for restoring).</p>
<h2><a class="anchor" id="autotoc_md157"></a>
Crash Callstacks</h2>
<p>When DynamoRIO catches an unhandled exception, the callstack should have a <code>dynamorio!intercept_exception</code> frame. Navigate to that frame, where we have a <code>CONTEXT*</code> local var named <code>cxt</code>. Then change the thread's context and ask for a stack trace. So if you see in the initial callstack:</p>
<div class="fragment"><div class="line"> 1. Child-SP          RetAddr           Call Site</div>
<div class="line">00 00000000`bfc9df68 00000000`153f05f6 ntdll!NtRaiseHardError+0xa</div>
<div class="line">01 00000000`bfc9df70 00000000`153a93ed dynamorio!nt_messagebox+0x176 [@ 3486](...\dr\git\src\core\win32\ntdll.c)</div>
<div class="line">02 00000000`bfc9e010 00000000`15177168 dynamorio!debugbox+0x5d [@ 4570](...\dr\git\src\core\win32\os.c)</div>
<div class="line">03 00000000`bfc9e040 00000000`153e132d dynamorio!notify+0x298 [@ 1956](...\dr\git\src\core\utils.c)</div>
<div class="line">04 00000000`bfc9e8b0 00000000`15548cfc dynamorio!intercept_exception+0x27dd [@ 5521](...\dr\git\src\core\win32\callback.c)</div>
<div class="line">05 00000000`bfc9ee60 00000000`bfc9ee80 dynamorio!interception_code_array+0xcfc</div>
</div><!-- fragment --><p>Execute these commands:</p>
<div class="fragment"><div class="line">.frame 4</div>
<div class="line">.cxr @@(cxt)</div>
<div class="line">kn</div>
</div><!-- fragment --><p>And now you should see the callstack as of the exception itself.</p>
<h2><a class="anchor" id="autotoc_md158"></a>
Creating Core Dumps</h2>
<p>You can create a core dump from windbg that allows others, or you at a later date, to re-analyze the bug:</p>
<div class="fragment"><div class="line">.dump /ma c:\path\to\new\dump\file.dmp</div>
</div><!-- fragment --><p>It is good practice to always create a dump file when attaching windbg, just in case the bug is not reproducible.</p>
<h2><a class="anchor" id="autotoc_md159"></a>
Debugging .ldmp Files</h2>
<p>.ldmp files are generated automatically by the core in certain failure situations. The failure situations on which a .ldmp file is created are specified by the <code>-dumpcore_mask</code> option (see the enum in core/os_shared.h), which defaults to 0x1ff in debug builds and to 0x0 in release builds. An additional parameter <code>-dumpcore_violation_threshold</code> controls the maximum number of violation .ldmp files to generate.</p>
<p>Once you have a .ldmp file you can use it to recreate the process for debugging purposes. To do so use the ldmp.exe utility in the tools module. The syntax is:</p>
<div class="fragment"><div class="line">% ./ldmp.exe &lt;ldmp_file&gt; &lt;dummy_executable&gt;</div>
</div><!-- fragment --><p>where <code>ldmp_file</code> is the ldmp you wish to view and <code>dummy_executable</code> is a fully qualified absolute windows style path to <code>dummy.exe</code> (also located in the tools module).</p>
<p>A cygwin example: </p><div class="fragment"><div class="line">% ./ldmp.exe ../foo.ldmp c:\\foo\\bar\\tools\\dummy.exe</div>
</div><!-- fragment --><p>A cmd shell example: </p><div class="fragment"><div class="line">% ldmp ../foo.ldmp c:\foo\bar\tools\dummy.exe</div>
</div><!-- fragment --><p>Ldmp will print out a process id and a bunch of mapping information. Use WinDbg to attach to the process id specified, making sure to attach NON-INVASIVELY** (you will crash WinDbg with an invasive attach). You should now be ready to debug.</p>
<p>Note that process ids and thread ids will differ from the original process as well as peb and teb addresses (though not contents, so you can still use !teb and !peb). Ldmp.exe provides mapping information from original thread ids and teb addrs to new thread ids and teb addrs as well as mappings for any other memory regions that were moved. Note that ldmp.exe can only recreate threads that were in our all_threads list at the time the ldmp was created, though ldmp.exe will try to detect teb regions associated with the missing threads. Handle information will not be available. MEM_TYPE information is also lost, but it is available in the human readable parts of the ldmp file. It is expected that ldmp.exe will be unable to copy over the shared_user_data/vsyscall page (so note that if debugging across os versions).</p>
<p>Once you are finished you will need to use task manager or DRkill.exe to kill the recreated process (will show up as dummy.exe unlike in WinDbg). Ldmp files are also somewhat human readable.</p>
<h2><a class="anchor" id="autotoc_md160"></a>
Kernel debugging</h2>
<p>Some debugging scenarios include services that start very early in the system initialization before we are able to start any programs - including debuggers. Also, sometimes even at a later stage a machine becomes completely unresponsive. Our only resort to getting control over such a machine is with a kernel debugger. Later we'll add notes here on how to use a kernel debugger.</p>
<h2><a class="anchor" id="autotoc_md161"></a>
System Dumps</h2>
<p>If a Windows machine is hung without a chance of attaching a user mode debugger we can still get a full system dump with a keyboard command.</p>
<p>This dump file requires a pagefile on your boot drive that is at least as large as your main system memory. Also verify that you have free space on your drive for the dump file itself. This means you need at least 2xRAM to be able to do this.</p>
<p>How to set it up:</p>
<ul>
<li>Go to Control Panel | System | Advanced | Startup and Recovery Settings</li>
<li>Choose a Complete Memory Dump and note the location: it should be <code>SystemRoot%\MEMORY.DMP</code></li>
<li>Keep the overwrite setting checked, but remember after getting a dump to rename it with a meaningful name if you want to keep it</li>
<li>Go to Performance Settings | Advanced | Virtual Memory and make sure you have a large enough pagefile</li>
</ul>
<p>To set up the key combination, set this registry key:</p>
<div class="fragment"><div class="line">[<span class="stringliteral">&quot;CrashOnCtrlScroll&quot;</span>=dword:00000001</div>
</div><!-- fragment --><p>The magic key combination is <code>[[Right|Ctrl]]+[[Scroll|Lock]] [[Scroll|Lock]]</code></p>
<p>See <a href="http://support.microsoft.com/kb/244139/">http://support.microsoft.com/kb/244139/</a> for details on changing which keys are used, in case you're using a KVM that messes it up.</p>
<h2><a class="anchor" id="autotoc_md162"></a>
Remote Debugging</h2>
<p>There is also an easy way to debug remotely with WinDbg when you can actually start it on the target machine. This saves you the trouble of VNCing or to the target and we should give it a try. Of course, in this mode it is not secure at all - read up on docs for better ways of doing this if you like it.</p>
<div class="fragment"><div class="line">% windbg -server tcp:port=1099 -p PID</div>
<div class="line">% windbg -remote tcp:server=SERVER-NAME,port=1099</div>
<div class="line"> </div>
<div class="line">% <span class="stringliteral">&quot;C:\Progra~1\Debugg~1\ntsd.exe&quot;</span> -server tcp:port=1227 -g -x <span class="stringliteral">&quot;C:\WINNT\System32\notepad.exe&quot;</span></div>
</div><!-- fragment --><p>You can also set this in </p><div class="fragment"><div class="line">HKLM\Software\Microsoft\Windows NT\Current version\Image File Options</div>
</div><!-- fragment --><p>However, be careful not to try this on services like <code>winlogon.exe</code> on which it doesn't work. You will need a recovery CD if you mess it up.</p>
<p>Note that if you have already started a debug session you can easily convert it into a remote server with </p><div class="fragment"><div class="line">&gt; .server tcp:port=1099</div>
</div><!-- fragment --><p>and such debugging is much faster than over RDP or VNC, and helpful for sharing a debug session with someone else.</p>
<h2><a class="anchor" id="autotoc_md163"></a>
WinDbg Tips</h2>
<p>These apply only to debug builds:</p>
<ul>
<li>Dump stats: <code>dt stats</code></li>
<li>See info on all locks - most importantly contention stats: <code>dt innermost_lock -l next_process_lock</code></li>
</ul>
<p>These work in both release and debug:</p>
<ul>
<li>Always save to a logfile via the .logopen command. After debugging, copy the logfile to the bug directory to keep a record of your analysis. This is particularly important for a bug you gave up on or didn't have time to complete analysis of.</li>
<li>Dump all callstacks:<ul>
<li>In user mode debugger: <code>~*kp</code></li>
<li>In kernel mode debugger on XP+: <code>!process 0 1f [lsass.exe](HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\i8042prt\Parameters])</code></li>
</ul>
</li>
<li>Check which build you're using in the target: <code>lm vm dynamorio</code></li>
<li><p class="startli">Dump heap units:</p>
<p class="startli">You need to obtain the heap.units address and then dump the first two fields in the !list command:</p>
<p class="startli">``` &gt; dt dynamorio!heap units . +0x000 units : 0x1a151000 +0x000 start_pc : 0x1a15101c "1X@" +0x004 end_pc : 0x1a160fff "" ```</p>
<p class="startli">Alternatively:</p>
<p class="startli">``` &gt; ?? heap.units struct theHeapUnit * 0x1a151000</p>
<p class="startli">&gt; !list -t theHeapUnit.next_global -x "dd" -a "L2" 0x1a151000 dd 1a151000 L2 1a151000 1a15101c 1a160fff</p>
<p class="startli">dd 1a131000 L2 1a131000 1a13101c 1a140fff ```</p>
</li>
<li>See current memory state with initial allocation information: <code>!vadump -v</code></li>
<li><p class="startli">Use the scripts in the <code>tools/windbg-scripts</code> module to simplify analyses of DynamoRIO data structures.</p>
<p class="startli">Invoke by setting up parameters in the pseudo-registers and then using the <code>$&gt;&lt;</code> command:</p>
</li>
</ul>
<div class="fragment"><div class="line">&gt; r $t0=18345270</div>
<div class="line">&gt; $&gt;&lt;c:\path\to\tools\windbg-scripts\fragment_flags</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md164"></a>
Addr2Line</h2>
<p>The address_query.pl script in the tools module can be used for a command-line address-to-line utility. It requires that you have already built DRload.exe in the tools module. It will use cdb if you've installed the Debugging Tools for Windows in the standard location; otherwise it uses the ntsd present on every machine and goes through a temporary log file.</p>
<p>It can take as input stdin, a file, or command-line arguments listing the addresses to be queried. Here's the usage:</p>
<div class="fragment"><div class="line">Usage: /i/dr/tools/address_query.pl [[-f &lt;addrfile&gt;](-raw]) [&lt;debuggerpath&gt;](-d) &lt;DRdllpath&gt; [... &lt;addrN&gt;](&lt;addr1&gt;)</div>
</div><!-- fragment --><p>Here's an example using a command-line argument: </p><div class="fragment"><div class="line">% address_query.pl /i/dr/builds/11105/exports/x86_win32_rel/dynamorio.dll 0x7000ddb9</div>
<div class="line"> </div>
<div class="line">0x7000ddb9:</div>
<div class="line">vmareas.c(2420)+0x1</div>
<div class="line">(7000dc40)   dynamorio!check_thread_vm_area+0x179   |  (7000e1b0)   dynamorio!prepend_fraglist</div>
</div><!-- fragment --><p>As another example, if you have a callstack in the file "cstack" with two columns (frame pointers followed by addresses), you could do something like this:</p>
<div class="fragment"><div class="line">% awk <span class="stringliteral">&#39;{print $2}&#39;</span> &lt; cstack | address_query.pl /c/derek/dr/builds/11087/exports/x86_win32_rel/dynamorio.dll</div>
<div class="line"> </div>
<div class="line">77f830e7:</div>
<div class="line">(77f82f56)   ntdll!RtlMultiByteToUnicodeN+0x190   |  (77f8e415)   ntdll!RtlpExecuteHandlerForException</div>
<div class="line"> </div>
<div class="line">77f8d96b:</div>
<div class="line">(77f8d86d)   ntdll!LdrpResolveDllName+0x11c   |  (77f912cf)   ntdll!RtlpInitDeferedCriticalSection</div>
<div class="line"> </div>
<div class="line">77f8da9e:</div>
<div class="line">(77f8da40)   ntdll!LdrpCreateDllSection+0x60   |  (77f912cf)   ntdll!RtlpInitDeferedCriticalSection</div>
<div class="line"> </div>
<div class="line">77f88a29:</div>
<div class="line">(77f8b3cf)   ntdll!RtlAllocateHeapSlowly+0x84f   |  (77f85a4e)   ntdll!RtlFreeHandle</div>
</div><!-- fragment --><p>See the comments at the top of the script for more information. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:02:53 &nbsp; <img border=0 src="favicon.png">
</small></address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>
