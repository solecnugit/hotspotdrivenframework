---
title: "Building from Source"
layout: default
permalink: /page_building.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Building from Source </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md73"></a>
Quick Start</h1>
<p>If you don't need to modify DR and just need a recent build, you can download <a class="el" href="page_weekly_builds.html">weekly package builds</a>.</p>
<h2><a class="anchor" id="autotoc_md74"></a>
Linux</h2>
<p>To build DynamoRIO on Linux, use the following commands as a guide. This builds 64-bit DynamoRIO in release mode:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Install dependencies for Ubuntu 15+.  Adjust this command as appropriate for</span></div>
<div class="line"><span class="preprocessor"># other distributions (in particular, use &quot;cmake3&quot; for Ubuntu Trusty).</span></div>
<div class="line">$ sudo apt-get install cmake g++ g++-multilib doxygen git zlib1g-dev libunwind-dev</div>
<div class="line"><span class="preprocessor"># Get sources.</span></div>
<div class="line">$ git clone https:<span class="comment">//github.com/DynamoRIO/dynamorio.git</span></div>
<div class="line"><span class="preprocessor"># Make a separate build directory.  Building in the source directory is not</span></div>
<div class="line"><span class="preprocessor"># supported.</span></div>
<div class="line">$ cd dynamorio &amp;&amp; mkdir build &amp;&amp; cd build</div>
<div class="line"><span class="preprocessor"># Generate makefiles with CMake.  Pass in the path to your source directory.</span></div>
<div class="line">$ cmake ..</div>
<div class="line"><span class="preprocessor"># Build.</span></div>
<div class="line">$ make -j</div>
<div class="line"><span class="preprocessor"># Run echo under DR to see if it works.  If you configured for a debug or 32-bit</span></div>
<div class="line"><span class="preprocessor"># build, your path will be different.  For example, a 32-bit debug build would</span></div>
<div class="line"><span class="preprocessor"># put drrun in ./bin32/ and need -debug flag to run debug build.</span></div>
<div class="line">$ ./bin64/drrun echo hello world</div>
<div class="line">hello world</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md75"></a>
Windows</h2>
<p>To build DynamoRIO on Windows, first install the following software.</p>
<ul>
<li>Visual Studio 2017. Other versions are not officially supported as our automated tests use VS 2017.</li>
<li><a href="http://cmake.org/cmake/resources/software.html">CMake</a>. 3.7+ is required. When prompted, we recommend adding it to your PATH.</li>
<li>Git. Any flavor should do, including <a href="https://git-scm.com/download/win">Git on Windows</a> or Cygwin git.</li>
<li>Perl. We recommend either <a href="http://strawberryperl.com/">Strawberry Perl</a> or Cygwin perl.</li>
<li>(optional) <a href="http://cygwin.com">Cygwin</a>. Only needed for building documentation. Select the doxygen package if you do install it. (You can also select Cygwin's perl and git as alternatives to the links above.)</li>
</ul>
<p>Once these dependencies are installed, you need to generate your project and solution files for Visual Studio using CMake. The easiest way to do this is to launch a cmd prompt with the right environment from the Visual Studio folder in the Start menu.</p>
<p>To build 32-bit DynamoRIO in release mode, launch the <code>Visual Studio 2017 &gt; x86 Native Tools Command Prompt for VS 2017</code> and run the following commands:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Get sources.</span></div>
<div class="line">$ git clone https:<span class="comment">//github.com/DynamoRIO/dynamorio.git</span></div>
<div class="line"><span class="preprocessor"># Make a separate build directory.  Building in the source directory is not</span></div>
<div class="line"><span class="preprocessor"># supported.</span></div>
<div class="line">$ cd dynamorio &amp;&amp; mkdir build &amp;&amp; cd build</div>
<div class="line"><span class="preprocessor"># Configure using cmake.  Pass in the path to your source directory.</span></div>
<div class="line">$ cmake -G<span class="stringliteral">&quot;Visual Studio 15&quot;</span> ..</div>
<div class="line"><span class="preprocessor"># Build from the command line.  Alternatively, open ALL_BUILD.vcproj in Visual</span></div>
<div class="line"><span class="preprocessor"># Studio and build from there.  You must pass --config to work around a cmake</span></div>
<div class="line"><span class="preprocessor"># bug.  (http://www.cmake.org/Bug/view.php?id=11830)</span></div>
<div class="line">$ cmake --build . --config RelWithDebInfo</div>
<div class="line"><span class="preprocessor"># Run notepad under DR to see whether it worked.</span></div>
<div class="line"><span class="preprocessor">$ bin32\drrun.exe notepad.exe</span></div>
</div><!-- fragment --><p>If you need a 64-bit build, choose <code>x64 Native Tools Command Prompt</code> and pass <code>-G"Visual Studio 15 Win64"</code> to cmake.</p>
<p>An alternative to the command prompt is to execute the appropriate vcvars.bat command for your compiler in your shell of choice.</p>
<p>For developers who plan to modify the DynamoRIO sources and build on a regular basis, we recommend using <a class="el" href="page_building.html#sec_ninja">Ninja</a>.</p>
<h2><a class="anchor" id="autotoc_md76"></a>
Debug Build</h2>
<p>If you plan to make changes to the source code, or for debugging problems in clients, you may wish to configure DynamoRIO in debug mode. Turn on the DEBUG flag when configuring, like this on Linux:</p>
<div class="fragment"><div class="line">$ cmake -DDEBUG=ON ..</div>
<div class="line">$ make -j</div>
</div><!-- fragment --><p>or on Windows: </p><div class="fragment"><div class="line">$ cmake -G<span class="stringliteral">&quot;Visual Studio 15&quot;</span> .. -DDEBUG=ON</div>
<div class="line">$ cmake --build . --config Debug</div>
</div><!-- fragment --><p>Passing -DCMAKE_BUILD_TYPE=Debug to cmake does <b>not</b> produce a debug build currently.</p>
<p>For 64-bit build on Windows: </p><div class="fragment"><div class="line">$ cmake -G<span class="stringliteral">&quot;Visual Studio 15 Win64&quot;</span> .. -DDEBUG=ON</div>
<div class="line">$ cmake --build . --config Debug</div>
</div><!-- fragment --><p>For 32-bit build on 64-bit Linux </p><div class="fragment"><div class="line">$ CFLAGS=-m32 CXXFLAGS=-m32 cmake -DDEBUG=ON ..</div>
<div class="line">$ make -j</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md77"></a>
Installing from a Local Build</h2>
<p>To mirror the layout and functionality of an official released package, build the <code>install</code> target. The <code>CMAKE_INSTALL_PREFIX</code> cmake variable controls the destination of the installation.</p>
<p>Once you've installed locally, you can now point at the installation just like you'd point at a release package for the purposes of building separate clients.</p>
<hr  />
<h1><a class="anchor" id="sec_build_linux"></a>
Details for Building on Linux</h1>
<p>In order to build you'll need the following packages:</p>
<ul>
<li>gcc</li>
<li>binutils</li>
<li>cmake (at least version 3.7)</li>
<li>perl</li>
</ul>
<p>In order to build the documentation, you will additionally need:</p>
<ul>
<li>doxygen</li>
</ul>
<p>We have tested the following versions of gcc: 4.4.3, 4.3.0, 4.1.2, and 3.4.3.</p>
<p>If your machine does not have support for running 32-bit applications and its version of binutils is older than 2.18.50 then you'll need to set the <code>CMAKE_ASM_COMPILER</code> CMake cache variable to point at a GNU assembler of at least version 2.18.50.</p>
<h2><a class="anchor" id="autotoc_md79"></a>
Setup for Simultaneous 64-bit and 32-bit Building</h2>
<p>In order to build both 32-bit and 64-bit on the same platform you'll need compiler support for targeting both architectures. Then install these packages:</p>
<div class="fragment"><div class="line">sudo apt-get install cmake g++ g++-multilib doxygen zlib1g-dev libunwind-dev libunwind-dev:i386</div>
</div><!-- fragment --><p>For older distributions, the <code>ia32-libs</code> package is needed.</p>
<p>For 64-bit Fedora, you'll need this package to build the samples:</p>
<div class="fragment"><div class="line">yum -y install glibc-devel.i?86</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md80"></a>
Building 32-bit DynamoRIO on 64-bit Linux</h2>
<p>To build a 32-bit version of DynamoRIO on a 64-bit platform, add -m32 to CFLAGS and CXXFLAGS in your environment when you first generate your Makefiles with CMake. Adding -m32 to the environment and re-running CMake in an existing build directory will not re-configure the makefiles to produce a 32-bit build, so you will need to create a separate build directory.</p>
<div class="fragment"><div class="line">CXXFLAGS=-m32 CFLAGS=-m32 cmake ..</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md81"></a>
Useful Configuration Options</h2>
<p>By default we build with -Werror on Linux, so if your build fails due to compiler warnings that we have not encountered, you should enable the DISABLE_WARNINGS option to allow the build to proceed.</p>
<p>If you wish to run the test suite, you should enable BUILD_TESTS.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md83"></a>
Cross-Compiling for ARM on Linux</h2>
<p>Install the cross compiler for the <code>gnueabihf</code> target:</p>
<div class="fragment"><div class="line">$ sudo apt-get install gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf g++-arm-linux-gnueabihf</div>
</div><!-- fragment --><p>Check out the sources as normal, and point at our toolchain CMake file:</p>
<div class="fragment"><div class="line">$ git clone https:<span class="comment">//github.com/DynamoRIO/dynamorio.git</span></div>
<div class="line">$ mkdir build_arm</div>
<div class="line">$ cd build_arm</div>
<div class="line">$ cmake -DCMAKE_TOOLCHAIN_FILE=../dynamorio/make/toolchain-arm32.cmake ../dynamorio</div>
<div class="line">$ make -j</div>
</div><!-- fragment --><p>To build a client, again use the toolchain file, as well as pointing at a DynamoRIO installation using <code>-DDynamoRIO_DIR=&lt;path&gt;</code> as described in the package documentation.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md85"></a>
Cross-Compiling for ARM Android</h2>
<p>Install the Android NDK (Note: currently only version r10e can be used to build DynamoRIO, later versions do not work, see #1927, #2556)and configure it for the androideabi standalone toolchain. Something like this:</p>
<div class="fragment"><div class="line">wget https:<span class="comment">//dl.google.com/android/repository/android-ndk-r10e-linux-x86_64.zip</span></div>
<div class="line">unzip android-ndk-r10e-linux-x86_64.zip</div>
<div class="line">android-ndk-r10e/build/tools/make-standalone-toolchain.sh --arch=arm --platform=android-21 --install-dir=/mytooldir/android-ndk-21 --toolchain=arm-linux-androideabi-4.9</div>
</div><!-- fragment --><p>Switch from the gold linker to bfd:</p>
<div class="fragment"><div class="line">ln -sf arm-linux-androideabi-ld.bfd /mytooldir/android-ndk-21/bin/arm-linux-androideabi-ld</div>
<div class="line">ln -sf ld.bfd /mytooldir/android-ndk-21/arm-linux-androideabi/bin/ld</div>
</div><!-- fragment --><p>Now check out the sources as normal, and point at our toolchain CMake file. If you have an attached Android device and the <code>adb</code> utility on your PATH, set the <code>DR_COPY_TO_DEVICE</code> variable to get the binaries needed for running tests automatically copied over via <code>adb push</code>.</p>
<div class="fragment"><div class="line">$ git clone https:<span class="comment">//github.com/DynamoRIO/dynamorio.git</span></div>
<div class="line">$ mkdir build_android</div>
<div class="line">$ cd build_android</div>
<div class="line">$ cmake -DCMAKE_TOOLCHAIN_FILE=../dynamorio/make/toolchain-android.cmake -DANDROID_TOOLCHAIN=/mytooldir/android-ndk-21 -DDR_COPY_TO_DEVICE=ON ../dynamorio</div>
<div class="line">$ make -j</div>
</div><!-- fragment --><p>If your Android system does not have a writable <code>/data/local/tmp</code> directory, you will need to either set <code>DYNAMORIO_CONFIGDIR</code> to a writable location or always run from a writable current directory.</p>
<p>After building, check that libdynamorio.so does not contain an INTERP segment:</p>
<div class="fragment"><div class="line">readelf -l lib32/debug/libdynamorio.so | grep INTERP</div>
</div><!-- fragment --><p>If it does, then you have probably used the gold linker instead of the bfd linker; see above.</p>
<p>If you have an Android device set up for access through the <code>adb shell</code> utility, the Android build is capable of automatically copying binaries to the device and running tests. First, ensure that <code>adb</code> is on your PATH, and that <code>adb status</code> indicates an attached device. Next, set the cmake variable <code>DR_COPY_TO_DEVICE</code>. This sets up post-build steps for each target needed by the tests to copy binaries over to the device. Now <code>ctest</code> should work when run from the host machine.</p>
<hr  />
<h2><a class="anchor" id="sec_aarch_on_x86"></a>
Building AArchXX Tooling to Execute on x86</h2>
<p>DR has support for executing on x86/amd64 while decoding and encoding for AArch64 or ARM. This is mostly used for standalone decoding and for analyzing on an x86 machine drcachesim memory address traces gathered on an AArch64 machine.</p>
<p>To build, set the <code>TARGET_ARCH</code> CMake variable:</p>
<div class="fragment"><div class="line">$ uname -m</div>
<div class="line">x86_64</div>
<div class="line">$ cmake -GNinja -DTARGET_ARCH=aarch64 ../src</div>
<div class="line">$ ninja drdisas</div>
<div class="line">$ clients/bin64/drdisas 12345678</div>
<div class="line"> 12345678   and    %w19 $0xfffff003 $0x0d15 -&gt; %w24</div>
</div><!-- fragment --><p>Support for aarch64-on-x86 on Windows is not yet finished; nor is support for other target-host combinations.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md88"></a>
Details for Building on Windows</h1>
<h2><a class="anchor" id="autotoc_md89"></a>
Compiler</h2>
<p>First, you need the compiler, linker, and associated tools. Install Visual Studio 2017 which is the version used by our automated tests.</p>
<p>You need to use a shell with command line support for using your compiler. For example, this could be the <code>cmd</code> shell or a Cygwin shell. You need to set the environment variables <code>INCLUDE</code>, <code>LIB</code>, <code>LIBPATH</code>, and <code>PATH</code> to point at the proper directories for your compiler. You can use the <code>vcvarsall.bat</code> script that comes with the compiler (in the <code>VC</code> directory) to set these variables for the <code>cmd</code> shell. For 64-bit, be sure to use <code>vcvarsall.bat amd64</code>, or directly run <code>vcvarsamd64.bat</code>. Do NOT use <code>vcvarsall.bat x86_amd64</code> or <code>vcvarsx86_amd64.bat</code>.</p>
<p>To build a 32-bit version of DynamoRIO on a 64-bit platform, set up your environment to use the x64 tools. As mentioned above, you can launch the command prompt from the Visual Studio Start menu folder, or run the "vcvarsall.bat amd64" script.</p>
<h2><a class="anchor" id="autotoc_md90"></a>
CMake</h2>
<p>You need CMake (version 3.7+) for Windows (<em>not</em> for Cygwin, as we need to pass paths with drive letters to our compiler). You can download a binary installation here:</p>
<p><a href="http://www.cmake.org/cmake/resources/software.html">http://www.cmake.org/cmake/resources/software.html</a></p>
<p>Install CMake and put its bin directory on the path for your shell.</p>
<h2><a class="anchor" id="autotoc_md91"></a>
Other Tools</h2>
<p>In order to build you must have a version of perl. It can be either a Cygwin perl or a native Windows perl.</p>
<p>In order to build the documentation, you will additionally need:</p>
<ul>
<li>doxygen</li>
</ul>
<p>These can be either Cygwin packages or native Windows. TH`.</p>
<h2><a class="anchor" id="autotoc_md92"></a>
Using Cygwin</h2>
<p>If you wish to run your build commands in a Cygwin bash shell, you will need to set up your environment the way that Visual Studio sets up the environment. Below is an example that supports multiple versions of Visual Studio installed simultaneously. It assumes that <code>/cygdrive/c</code> has been mounted as <code>/c</code>. Note the use of <em>mixed paths</em> (i.e., using a drive letter but forward slashes) for all variables except for <code>PATH</code>:</p>
<pre class="fragment">  # save PATH so we can swap between VS versions below
  export PRE_VS_PATH=$PATH

  # pass 0 to not use 8.x, and 0 in 2nd arg to not use 7.1
  function set_SDKROOT2 {
      # VS2008 puts rc and mc in 64-bit ProgFiles/MS SDKs
      export SDK2_SFX_INC=""
      export SDK2_SFX_LIB_X86=""
      export SDK2_SFX_LIB_X64="/x64"
      if [ "$1" != "0" ] &amp;&amp; test -e /c/Program\ Files\ \(x86\)/Windows\ Kits/8.1; then
          export SDKROOT2=`cygpath -d /c/Program\ Files\ \(x86\)/Windows\ Kits/8.1`
          export SDK2_SFX_INC="/um"
          export SDK2_SFX_LIB_X86="/winv6.3/um/x86"
          export SDK2_SFX_LIB_X64="/winv6.3/um/x64"
      elif [ "$1" != "0" ] &amp;&amp; test -e /c/Program\ Files\ \(x86\)/Windows\ Kits/8.0; then
          export SDKROOT2=`cygpath -d /c/Program\ Files\ \(x86\)/Windows\ Kits/8.0`
          export SDK2_SFX_INC="/um"
          export SDK2_SFX_LIB_X86="/win8/um/x86"
          export SDK2_SFX_LIB_X64="/win8/um/x64"
      elif [ "$2" != "0" ] &amp;&amp; test -e /c/Program\ Files/Microsoft\ SDKs/Windows/v7.1; then
          export SDKROOT2=`cygpath -d /c/Program\ Files/Microsoft\ SDKs/Windows/v7.1`
      elif test -e /c/Program\ Files/Microsoft\ SDKs/Windows/v7.0; then
          export SDKROOT2=`cygpath -d /c/Program\ Files/Microsoft\ SDKs/Windows/v7.0`
      elif test -e /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A; then
          export SDKROOT2=`cygpath -d /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A`
      else
          export SDKROOT2=""
      fi
  }

  function compilerVS2013_32 {
      set_SDKROOT2 1 1
      export CMAKEGEN="Visual Studio 12"
      export CMAKEGEN64="Visual Studio 12 Win64"
      export SDKROOT=`cygpath -d /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio\ 12.0`
      ninja_x86
      export INCLUDE="${SDKROOT}/VC/INCLUDE"\;"${SDKROOT}/VC/ATLMFC/INCLUDE"\;"${SDKROOT}/Include"\;"${SDKROOT2}/Include${SDK2_SFX_INC}"\;"${SDKROOT2}/Include/shared"\;"${SDKROOT2}/Include/winrt"
      export LIB="${SDKROOT2}/Lib${SDK2_SFX_LIB_X86}"\;"${SDKROOT}/VC/LIB"\;"${SDKROOT}/Lib"\;"${SDKROOT}/VC/PlatformSDK/Lib"\;"${SDKROOT}/VC/atlmfc/lib"
      # cmake bails if don't have LIBPATH set, though we don't need it
      export LIBPATH="${SDKROOT}/VC/atlmfc/lib"
      # put prior to /usr/bin for link.exe to beat out cygwin link.exe
      # VS2013 puts rc and mc in 32-bit ProgFiles/Windows Kits
      export PATH=`cygpath -u ${SDKROOT}/VC/Bin`:`cygpath -u ${SDKROOT2}/bin/x86`:`cygpath -u $SDKROOT/Common7/IDE`:${PRE_VS_PATH}
  }

  function compilerVS2013_64 {
      set_SDKROOT2 1 1
      export CMAKEGEN="Visual Studio 12"
      export CMAKEGEN64="Visual Studio 12 Win64"
      export SDKROOT=`cygpath -d /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio\ 12.0`
      ninja_x64
      export INCLUDE="${SDKROOT}/VC/INCLUDE"\;"${SDKROOT}/VC/ATLMFC/INCLUDE"\;"${SDKROOT}/Include"\;"${SDKROOT2}/Include${SDK2_SFX_INC}"\;"${SDKROOT2}/Include/shared"\;"${SDKROOT2}/Include/winrt"
      export LIB="${SDKROOT2}/Lib${SDK2_SFX_LIB_X64}"\;"${SDKROOT}/VC/LIB/amd64"\;"${SDKROOT}/Lib"\;"${SDKROOT}/VC/PlatformSDK/Lib/AMD64"\;"${SDKROOT}/VC/atlmfc/lib/amd64"
      export LIBPATH="${SDKROOT}/VC/atlmfc/lib/amd64"
      # We need the base VC/Bin/ for 32-bit mspdb*.dll for cross-compiler used by cmake
      export PATH=`cygpath -u ${SDKROOT}/VC/Bin/amd64`:`cygpath -u ${SDKROOT2}/bin/x64`:`cygpath -u ${SDKROOT}/VC/Bin`:${PRE_VS_PATH}
  }

  function compilerVS2017_32 {
      export CMAKEGEN="Visual Studio 15"
      export VSVER=$(ls -1t /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio/2017/Professional/VC/Tools/MSVC | head -1)
      export VSBASE=$(cygpath -d /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio/2017/Professional)
      export VSROOT=$(cygpath -d ${VSBASE}/VC/Tools/MSVC/$VSVER)
      # We assume SDK 10
      export KITROOT=$(cygpath -d /c/Program\ Files\ \(x86\)/Windows\ Kits/10)
      export KITVER=$(ls -1t /c/Program\ Files\ \(x86\)/Windows\ Kits/10/Include | head -1)
      ninja_x86
      export INCLUDE="${VSROOT}/include"\;"${VSROOT}/atlmfc/include"\;"${KITROOT}/Include/${KITVER}/um"\;"${KITROOT}/Include/${KITVER}/ucrt"\;"${KITROOT}/Include/${KITVER}/shared"\;"${KITROOT}/Include/${KITVER}/winrt"\;
      export LIB="${VSROOT}/lib/x86"\;"${VSROOT}/atlmfc/lib/x86"\;"${KITROOT}/lib/${KITVER}/ucrt/x86"\;"${KITROOT}/lib/${KITVER}/um/x86"
      # cmake bails if don't have LIBPATH set, though we don't need it
      export LIBPATH="${VSROOT}/lib/x86"
      # put prior to /usr/bin for link.exe to beat out cygwin link.exe
      # VS2015 puts rc and mc in 32-bit ProgFiles/Windows Kits
      export PATH=`cygpath -u ${VSROOT}/bin/HostX86/x86`:`cygpath -u ${KITROOT}/bin/x86`:`cygpath -u ${KITROOT}/bin/${KITVER}/x86`:`cygpath -u ${VSBASE}/Common7/IDE`:${PRE_VS_PATH}
  }

  function compilerVS2017_64 {
      export CMAKEGEN="Visual Studio 15 Win64"
      export VSVER=$(ls -1t /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio/2017/Professional/VC/Tools/MSVC | head -1)
      export VSBASE=$(cygpath -d /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio/2017/Professional)
      export VSROOT=$(cygpath -d ${VSBASE}/VC/Tools/MSVC/$VSVER)
      # We assume SDK 10
      export KITROOT=$(cygpath -d /c/Program\ Files\ \(x86\)/Windows\ Kits/10)
      export KITVER=$(ls -1t /c/Program\ Files\ \(x86\)/Windows\ Kits/10/Include | head -1)
      ninja_x64
      export INCLUDE="${VSROOT}/include"\;"${VSROOT}/atlmfc/include"\;"${KITROOT}/Include/${KITVER}/um"\;"${KITROOT}/Include/${KITVER}/ucrt"\;"${KITROOT}/Include/${KITVER}/shared"\;"${KITROOT}/Include/${KITVER}/winrt"\;
      export LIB="${VSROOT}/lib/x64"\;"${VSROOT}/atlmfc/lib/x64"\;"${KITROOT}/lib/${KITVER}/ucrt/x64"\;"${KITROOT}/lib/${KITVER}/um/x64"
      # cmake bails if don't have LIBPATH set, though we don't need it
      export LIBPATH="${VSROOT}/lib/x64"
      # put prior to /usr/bin for link.exe to beat out cygwin link.exe
      # VS2015 puts rc and mc in 32-bit ProgFiles/Windows Kits
      export PATH=`cygpath -u ${VSROOT}/bin/HostX64/x64`:`cygpath -u ${KITROOT}/bin/x64`:`cygpath -u ${KITROOT}/bin/${KITVER}/x64`:`cygpath -u ${VSBASE}/Common7/IDE`:${PRE_VS_PATH}
  }

  if test -e /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio/2017; then
      compilerVS2017_32
  elif test -e /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio\ 12.0; then
      compilerVS2013_32
  fi</pre><p>However, if you get errors about mspdb80.dll or windows.h, this probably means that the environment isn't set up correctly. Open a cmd prompt with the correct Visual C++ environment variables and compare the INCLUDE, LIB, LIBPATH, and PATH environment variables in the two shells.</p>
<p>Note that you need Visual Studio's bin directories on your <code>PATH</code> <em>before</em> Cygwin's as there are conflicts: both have <code>mc.exe</code> and <code>link.exe</code>.</p>
<hr  />
<h1><a class="anchor" id="sec_cmake"></a>
Details of Building with CMake</h1>
<h2><a class="anchor" id="autotoc_md94"></a>
Components</h2>
<p>DynamoRIO contains several distinct components:</p>
<ul>
<li>core/ = the core tool engine shared library</li>
<li>api/ = the documentation and sample clients</li>
<li>tools/ = various tools, including for deployment (drdeploy.in and drdeploy.c) and statistics viewing (DRstats)</li>
<li>libutil/ = library used by drdeploy.c and DRstats</li>
<li>suite/ = tests</li>
</ul>
<p>All components are combined into a single CMake project.</p>
<h2><a class="anchor" id="autotoc_md95"></a>
Configuring Your Build</h2>
<p>First, configure your compiler. On Windows this means setting up the environment variables (including <code>PATH</code>). On Linux, if your compiler supports both 64-bit and 32-bit targets, you can select the non-default type by setting the <code>CFLAGS</code> and <code>CXXFLAGS</code> environment variables to the flags used to change your compiler's target. For example, for gcc:</p>
<div class="fragment"><div class="line">export CXXFLAGS=-m32</div>
<div class="line">export CFLAGS=-m32</div>
</div><!-- fragment --><p>Next, in your shell (which you have set up for building with your compiler), create a build directory. You cannot build DynamoRIO from source code directory directly! Invoke the CMake GUI from the build directory, pointing at the source directory. For example, if your current directory is the base of the DynamoRIO tree, on either Windows or Linux, run:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake-gui ..</div>
</div><!-- fragment --><p>Press Configure. On Windows, select <b>Visual Studio 15 2017</b>. On Linux, select <b>Unix Makefiles</b>.</p>
<p>If you are on Linux, <code>ccmake</code>, a curses-based GUI, can be used instead of <code>cmake-gui</code>; it generates <b>Unix Makefiles</b> by default. In <code>ccmake</code>, press <code>c</code> to configure.</p>
<p>On Windows, if you are building an old version of DynamoRIO (prior to r577), you will need to use <b>NMake Makefiles</b> instead of a Visual Studio generator. If you are in Cygwin, you can use <b>Unix Makefiles</b>, but the resulting build will be slower than using a Visual Studio generator.</p>
<p>Now you can select the parameters to configure your build. The main parameters are as follows (some may not be present if the configure process determined they do not apply: e.g., if you do not have <code>doxygen</code> installed you cannot selected <code>BUILD_DOCS</code>):</p>
<ul>
<li>BUILD_CORE = whether to build the core</li>
<li>BUILD_DOCS = whether to build the documentation</li>
<li>BUILD_DRSTATS = whether to build the DRstats viewer (Windows-only). Note that DRstats is currently 32-bit only (<a href="https://github.com/DynamoRIO/dynamorio/issues#issue/62">issue 62</a>), so when building a 64-bit Windows core you will need a separate build directory and configuration for 32-bit in order to build DRstats.</li>
<li>BUILD_TOOLS = whether to build the tools (primarily Windows)</li>
<li>BUILD_SAMPLES = whether to build the client samples</li>
<li>BUILD_TESTS = whether to build the tests</li>
<li>INSTALL_PREFIX = where to install the results after building</li>
<li>NTDLL_LIBPATH = where ntdll.lib is located (Windows-only)</li>
<li>DEBUG = whether to enable asserts and logging</li>
<li>INTERNAL = for DynamoRIO developer use</li>
<li>DISABLE_WARNINGS = useful if your version of gcc produces warnings we have not seen (we compile with warnings-are-errors)</li>
</ul>
<p>Press Configure and then OK (or <code>c</code> and then <code>g</code>) to complete the configuration step and generate the Makefiles. It is normal to see messages like this for various types (uint, ushort, bool, byte, sbyte, uint32, uint64, int32, int64):</p>
<div class="fragment"><div class="line">-- Check size of <span class="keywordtype">bool</span></div>
<div class="line">-- Check size of <span class="keywordtype">bool</span> - failed</div>
</div><!-- fragment --><p>This is really a check for the existence of a typedef and it is normal for some such checks to print a "failure" message.</p>
<p>On Windows, if you have both <code>cl</code> and <code>gcc</code> on your path, you can ensure that CMake selects <code>cl</code> by setting the <code>CC</code> and <code>CXX</code> environment variables. For example:</p>
<div class="fragment"><div class="line">CC=cl CXX=cl cmake ..</div>
</div><!-- fragment --><p>To improve compilation speed on Windows, if you are using a makefile-based generator (i.e., not Visual Studio), you can turn off the progress and status messages with this CMake define:</p>
<div class="fragment"><div class="line">-DCMAKE_RULE_MESSAGES:BOOL=OFF</div>
</div><!-- fragment --><p>On Windows, if you use Cygwin and hit <a href="http://www.cmake.org/Bug/print_bug_page.php?bug_id=13131">CMake bug#13131</a>, you may need to kill all running MSBuild instances and unset the <code>TMP</code> and <code>TEMP</code> environment variables.</p>
<h2><a class="anchor" id="autotoc_md96"></a>
Building</h2>
<p>After the configuration step is complete, for release build, type </p><div class="fragment"><div class="line">cmake --build . --config RelWithDebInfo</div>
</div><!-- fragment --><p>or if you turned on DEBUG, type </p><div class="fragment"><div class="line">cmake --build .</div>
</div><!-- fragment --><p>or if you are using <b>NMake Makefiles</b>, type </p><div class="fragment"><div class="line">nmake</div>
</div><!-- fragment --><p>or on Linux, type </p><div class="fragment"><div class="line">make</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md97"></a>
An Example of Building DynamoRIO in Windows-XP 64bit in cmd</h2>
<ul>
<li>step 1: set INCLUDE, LIB, LIBPATH, and PATH by running the Visual Studio Command Prompt, under the Visual Studio Tools in the Visual Studio start menu entry. Alternatively, from a plain cmd window: <div class="fragment"><div class="line">E:\&gt;<span class="stringliteral">&quot;c:\Program Files (x86)\Microsoft Visual Studio 8\VC\vcvarsall.bat&quot;</span></div>
</div><!-- fragment --></li>
</ul>
<p>or for 64-bit build </p><div class="fragment"><div class="line">E:\&gt;<span class="stringliteral">&quot;c:\Program Files (x86)\Microsoft Visual Studio 8\VC\vcvarsall.bat&quot;</span> amd64</div>
</div><!-- fragment --><ul>
<li>step 2: get dynamorio source to <code>e:\dynamorio</code> via svn</li>
<li>step 3: in <code>e:\dynamorio</code>, create a directory for building <div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
</div><!-- fragment --></li>
<li>step 4: configure using cmake <pre class="fragment">E:\dynamorio\build\&gt;"c:\Program Files (x86)\CMake 3.7\bin\cmake-gui.exe" ..\
</pre><ul>
<li>step 4.1: click "Configure" button</li>
<li>step 4.2: select "Visual Studio 15"</li>
<li>step 4.3: generate configuration file</li>
</ul>
</li>
<li>step 5: build and install <pre class="fragment">E:\dynamorio\build\&gt;cmake --build . --config Release
</pre></li>
</ul>
<h2><a class="anchor" id="autotoc_md98"></a>
Configuring in Batch Mode</h2>
<p>Instead of interactive configuration you can pass all your parameter changes to CMake on the command line. For example:</p>
<p>On Windows: </p><div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -G<span class="stringliteral">&quot;Visual Studio 15&quot;</span> -DBUILD_DOCS:BOOL=OFF ..</div>
<div class="line">cmake --build . --config Release</div>
</div><!-- fragment --><p>On Linux: </p><div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -DBUILD_DOCS:BOOL=OFF ..</div>
<div class="line">make</div>
</div><!-- fragment --><p>Developers may wish to pass <code>-DCMAKE_VERBOSE_MAKEFILE=1</code> to CMake in order to see the compilation command lines. They can alternatively be seen for any individual build with <code>make VERBOSE=1</code>.</p>
<h2><a class="anchor" id="autotoc_md99"></a>
Re-Configuring</h2>
<p>You can re-run the configure step, using the same parameters that you originally used, in two ways:</p>
<div class="fragment"><div class="line">make rebuild_cache</div>
</div><!-- fragment --><p>Or:</p>
<div class="fragment"><div class="line">cmake .</div>
</div><!-- fragment --><p>With the latter command you can also change the configuration, but be sure to do a <code>make clean</code> prior to building as CMake does not perform dependence checking on this type of modification. As an example:</p>
<div class="fragment"><div class="line">cmake -DDEBUG=ON -DINTERNAL=ON .</div>
<div class="line">make clean</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md100"></a>
Building a Distributable Package</h2>
<p>If you've been working with DynamoRIO's packaged binaries, you may find it easiest to install all of the dependencies listed above for your platform and then run the packaging script:</p>
<div class="fragment"><div class="line">cd dynamorio</div>
<div class="line">mkdir <span class="keyword">package</span></div>
<div class="line"><span class="keyword"></span>cd package</div>
<div class="line">ctest -V -S ../make/package.cmake,build=1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md101"></a>
Details of CMake Visual Studio Generators</h2>
<p>As of version 577, DynamoRIO supports building from Visual Studio. The /MP flag is set by default for not only parallel project builds but parallel file builds. The fastest DynamoRIO build is a Visual Studio build from the command line.</p>
<p>First, DynamoRIO requires CMake version 3.7 or higher (to support Visual Studio 2017).</p>
<p>Then you can generate the Visual Studio project files with something like this:</p>
<div class="fragment"><div class="line">cmake -G<span class="stringliteral">&quot;Visual Studio 15&quot;</span> -DDEBUG=ON -DCMAKE_RULE_MESSAGES:BOOL=OFF ../src</div>
</div><!-- fragment --><p>You can build from the command line (actually for any generator) with this:</p>
<div class="fragment"><div class="line">cmake --build .</div>
</div><!-- fragment --><p>Due to a cmake bug (<a href="http://www.cmake.org/Bug/view.php?id=11830">http://www.cmake.org/Bug/view.php?id=11830</a>), for a release build you need to explicitly say you want release:</p>
<div class="fragment"><div class="line">cmake --build . --config Release</div>
</div><!-- fragment --><p>To request a particular target:</p>
<div class="fragment"><div class="line">cmake --build . --target dynamorio</div>
</div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line">cmake --build . --target install</div>
</div><!-- fragment --><h2><a class="anchor" id="sec_ninja"></a>
Using Ninja For Better Error Messages, Faster Builds, and Proper Incremental Builds</h2>
<p>Ninja is a new build system designed to work with automated build system generators like CMake:</p>
<p><a href="https://github.com/martine/ninja">https://github.com/martine/ninja</a></p>
<p>Ninja has much more readable build output, resulting in better error messages. It builds faster, and it automatically re-runs CMake when necessary, resulting in proper incremental builds. It's all-around a superior build experience from the command line.</p>
<p>There is a Windows build of Ninja checked in to make/ninja.exe. Simply put this on your PATH. Ninja has no dependencies and the executable can be placed anywhere.</p>
<p>In addition to having ninja.exe on your PATH, you need to set the environment variable ASM to "ml" for a 32-bit build and to "ml64" for a 64-bit build (otherwise Ninja tries to assemble using cl). If you have other compilers installed (such as Cygwin or MinGW), you should also set the CC and CXX environment variables. Here are sample bash functions:</p>
<div class="fragment"><div class="line"><span class="keyword">function</span> ninja_x86 {</div>
<div class="line">    export CC=cl</div>
<div class="line">    export CXX=cl</div>
<div class="line">    export ASM=ml</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> ninja_x64 {</div>
<div class="line">    export CC=cl</div>
<div class="line">    export CXX=cl</div>
<div class="line">    export ASM=ml64</div>
<div class="line">}</div>
</div><!-- fragment --><p>To configure, from a shell that has the Visual Studio environment set up, ninja.exe on the PATH, and the ASM environment variable set, run:</p>
<div class="fragment"><div class="line">cmake -G<span class="stringliteral">&quot;Ninja&quot;</span> ../src</div>
</div><!-- fragment --><p>From a Cygwin bash shell you could alternatively set the environment variables in the same command:</p>
<div class="fragment"><div class="line">CC=cl CXX=cl ASM=ml cmake -G<span class="stringliteral">&quot;Ninja&quot;</span> ../src</div>
</div><!-- fragment --><p>To build:</p>
<div class="fragment"><div class="line">ninja</div>
</div><!-- fragment --><p>Ninja builds in parallel by default.</p>
<p>To build a specific target:</p>
<div class="fragment"><div class="line">ninja dynamorio</div>
</div><!-- fragment --><p>One downside of the current CMake Ninja generator is that one must change the environment in order to switch to a 64-bit build directory (both the Visual Studio toolchain environment and the ASM environment variable mentioned above), whereas with the Visual Studio generator one can switch build directories without any environment changes (once the build directories are configured using the right environment).</p>
<p>The test suite supports using Ninja by passing the use_ninja parameter:</p>
<div class="fragment"><div class="line">ctest -V -S c:/mycheckout/suite/runsuite.cmake,use_ninja</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md102"></a>
Using Ninja With Pre-7.0 SDK</h3>
<p>If you end up using the (no longer officially supported) Visual Studio 2008, it's best to pair it with a pre-7.0 SDK, but Ninja runs into a problem there running <code>rc.exe</code>:</p>
<div class="fragment"><div class="line">fatal error RC1106: invalid option: -ologo</div>
</div><!-- fragment --><p>A workaround is to copy <code>rc.exe</code> and <code>rcdll.dll</code> from a post-7.0 SDK into the pre-7.0 SDK <code>Bin</code> directory, with admin privileges:</p>
<div class="fragment"><div class="line">mv /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A/Bin/RC.Exe /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A/Bin/RC-ORIG.Exe</div>
<div class="line">mv /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A/Bin/RcDll.Dll /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A/Bin/RcDll-ORIG.Dll</div>
<div class="line">cp /c/Program\ Files/Microsoft\ SDKs/Windows/v7.1/Bin/RC.Exe /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A/Bin/</div>
<div class="line">cp /c/Program\ Files/Microsoft\ SDKs/Windows/v7.1/Bin/RcDll.Dll /c/Program\ Files/Microsoft\ SDKs/Windows/v6.0A/Bin/</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md103"></a>
Using MSBuild For Slightly Better Error Messages And Faster Builds</h2>
<p>We recommend Ninja (see above) over MSBuild, but we're leaving the information on MSBuild here as it is recommended over devenv.</p>
<p>By default, CMake will use devenv when building for Visual Studio generators.</p>
<div class="fragment"><div class="line">cmake --build . --target Release -- /m</div>
</div><!-- fragment --><p>The /m (full name "/maxcpucount") option is only supported with .NET 3.5 or later. In practice this means Visual Studio 2010 or later. With no numeric argument (as shown in the command line above), it requests a concurrent number of jobs equal to the number of processors on the system.</p>
<p>MSBuild summarizes all build warnings and errors at the end of the run, unlike devenv. It is also a little faster than devenv (when parallel building is enabled). There are some general outstanding issues with MSBuild, but it seems to work well for DynamoRIO with Visual Studio 2010 and 2012. To request MSBuild set the CMAKE_MAKE_PROGRAM variable at configuration time. In a Visual Studio Command Prompt, MSBuild is on the PATH, so the absolute path is not needed:</p>
<div class="fragment"><div class="line">cmake -G<span class="stringliteral">&quot;Visual Studio 15&quot;</span> -DCMAKE_MAKE_PROGRAM:FILEPATH=MSBuild ../src</div>
</div><!-- fragment --><p>Don't forget to pass the "/m" flag (after "--") as shown above when building.</p>
<p>To request verbose build information, use the "/v:diag" flag:</p>
<div class="fragment"><div class="line">cmake --build . --target Release -- /m /v:diag</div>
</div><!-- fragment --><p>Here is a sample bash function to make building easier within Cygwin:</p>
<div class="fragment"><div class="line"><span class="keyword">function</span> build {</div>
<div class="line">    config=$(grep ^CMAKE_CONFIGURATION_TYPES:S CMakeCache.txt | sed <span class="stringliteral">&#39;s/^.*=//&#39;</span>)</div>
<div class="line">    /usr/bin/time cmake --build . --config $config -- /m</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md104"></a>
Using Unix Makefiles On Windows For Parallel Builds</h2>
<p>On Windows you can target <b>Unix Makefiles</b> in order to use GNU make and build in parallel (NMake does not support parallel builds; see also issue 71). However, note that Visual Studio generators support parallel builds and are faster than using Cygwin make.</p>
<p>If you have gcc installed you will have to explicitly tell the CMake generator to prefer cl:</p>
<div class="fragment"><div class="line">cmake -G<span class="stringliteral">&quot;Unix Makefiles&quot;</span> -DCMAKE_GENERATOR_CC=cl -DCMAKE_GENERATOR_CXX=cl ..</div>
</div><!-- fragment --><p>If you see this error from cygwin make: </p><div class="fragment"><div class="line">target pattern contains no `%<span class="stringliteral">&#39;.</span></div>
</div><!-- fragment --><p>Or during cmake configuration: </p><div class="fragment"><div class="line">Detecting C compiler ABI info - failed</div>
</div><!-- fragment --><p>That may not fail the configuration and you may see a later fatal failure: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> had incorrect arguments: ${sizeof_void} EQUAL 8 (Unknown arguments specified).</div>
</div><!-- fragment --><p>Then you need to switch to a version of make that supports colons in paths. One such version is 3.80, a copy of which (compiled for cygwin) is available in the make/ directory. I recommend copying it into your /usr/local/bin directory and either putting /usr/local/bin ahead of /usr/bin on your <code>PATH</code> or passing it to CMake explicitly:</p>
<div class="fragment"><div class="line">cmake -DCMAKE_MAKE_PROGRAM=$SYSTEMDRIVE/cygwin/usr/local/bin/make.exe</div>
</div><!-- fragment --><p>If you have a very recent cygwin installation you may need to put cygintl-2.dll from the make/ directory into /usr/local/bin as well.</p>
<p>Now you can build in parallel, which reduces build time:</p>
<div class="fragment"><div class="line">make -j6 install</div>
</div><!-- fragment --><p>Build time on Windows can be further improved by disabling progress and status messages (see <a href="https://github.com/DynamoRIO/dynamorio/issues#issue/71">issue 71</a>). To do so, use <code>-DCMAKE_RULE_MESSAGES=OFF</code>.</p>
<p>See <a href="https://github.com/DynamoRIO/dynamorio/issues#issue/71">issue 71</a> for some representative performance numbers, and for instructions on building with Mingw and the MSYS shell, which is a little faster than building under Cygwin.</p>
<p>Note that with more recent Visual Studio versions and machines with more than two cores we have seen some strange build errors that may be pdb creation races. We recommend using the Visual Studio generator instead if you are hitting these problems.</p>
<h1><a class="anchor" id="sec_drgui"></a>
Building the Qt DrGUI extension</h1>
<p>Simply install Qt 5.x and ensure that the architecture and compiler match what you will be using to build DynamoRIO. E.g., on Fedora: </p><div class="fragment"><div class="line">yum -y install qt5-qtbase.i686 qt5-qtbase-devel.i686</div>
</div><!-- fragment --><p>On Ubuntu, Qt 5 may not be in the standard repositories. You can install the 64-bit version with: </p><div class="fragment"><div class="line">apt-add-repository ppa:ubuntu-sdk-team/ppa</div>
<div class="line">apt-get install -y qtbase5-dev qtbase5-dbg</div>
</div><!-- fragment --><p>If Qt is installed in a non-standard location, set the Qt5Widgets_DIR cmake variable to point to the directory containing Qt5WidgetsConfig.cmake. E.g.: </p><div class="fragment"><div class="line">cmake -DQt5Widgets_DIR=/opt/Qt5.0.2/5.0.2/gcc/lib/cmake/Qt5Widgets/</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:02:57 &nbsp; <img border=0 src="favicon.png">
</small></address>
