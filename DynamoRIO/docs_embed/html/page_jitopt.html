---
title: "JIT Optimization"
layout: default
permalink: /page_jitopt.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">JIT Optimization </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a href="https://github.com/DynamoRIO/dynamorio/tree/experimental-optimize-jit">experimental-optimize-jit</a> branch was developed during a Google Summer of Code project in 2014 to address <a href="https://github.com/DynamoRIO/dynamorio/issues/1114">i#1114</a>. For a detailed description of the implementation, see our paper in <a href="http://dl.acm.org/citation.cfm?id=2738610">CGO 2015</a>.</p>
<h1><a class="anchor" id="autotoc_md184"></a>
Branch Content</h1>
<p>The special handling of DGC appears in the 3 files with the largest change sets:</p>
<ul>
<li><a href="https://github.com/DynamoRIO/dynamorio/blob/experimental-optimize-jit/core/jitopt.c">core/jitopt.c</a> (experimental counterpart of <a href="https://github.com/DynamoRIO/dynamorio/blob/master/core/jit_opt.c">core/jit_opt.c</a> on master)<ul>
<li>manages double-mapped pages (needs to be tested on a recent kernel)</li>
<li>maintains bookkeeping of DGC fragments in a bucket/hashtable</li>
<li>selectively flushes fragments as requested by JIT writers</li>
</ul>
</li>
<li><a href="https://github.com/DynamoRIO/dynamorio/blob/experimental-optimize-jit/core/arch/x86/mangle.c">core/arch/x86/mangle.c</a><ul>
<li>instruments JIT writer instrs to selectively flush fragments as necessary</li>
</ul>
</li>
<li><a href="https://github.com/DynamoRIO/dynamorio/blob/experimental-optimize-jit/core/vmareas.c">core/vmareas.c</a>:<ul>
<li>integrates JIT code regions into the vmarea accounting structures</li>
<li>synchronizes double-mappings with any changes to corresponding vmarea</li>
</ul>
</li>
</ul>
<p>In core/jitopt.c, the bucket/hashtable was an experimental approach that we found too difficult to maintain, particularly because the remove operation is too complicated. The goal of this structure was to allow instrumentation in the code cache to easily lookup overlapping fragments at any specific address. That aspect of it is very convenient, but it does not perform any better than a standard red/black tree, which is much easier to implement and maintain. So the instrumentation for JIT writers should be refactored to read the red/black tree instead of the bucket/hashtable.</p>
<p>One consideration for refactoring the instrumentation is that the read is racy (from the code cache), so the race conditions need to (continue to) fail nicely with a spurious "not found" instead of crashing with a segfault. This was accomplished in the prototype using a garbage collector that only flushed the removed hashtable entries after the last incoming pointer had been redirected</p>
<p>The red/black tree has already been committed to master in <a href="https://github.com/DynamoRIO/dynamorio/blob/master/core/jit_opt.c">core/jit_opt.c</a>. Part of the bucket/hashtable was implemented in the files <code>asmtable.[ch]</code>, which have not been included in this experimental branch&ndash;those references can be ignored, since all of that functionality is already replaced by the red/black tree on master.</p>
<p>The optimization may not perform well when the OS is configured to use huge pages (or any size larger than 4k). If that becomes a problem, hopefully it will be possible to maintain the 4k units in the JIT optimization's accounting structures, even though physical pages are larger. This may become tricky where vmareas interface with the OS, and also in the double-mappings.</p>
<h1><a class="anchor" id="autotoc_md185"></a>
Commit Workflow</h1>
<p>The workflow for this branch is to progressively implement features as individual commits on the <a href="https://github.com/DynamoRIO/dynamorio/tree/project-optimize-jit">project-optimize-jit</a> branch. Code in the experimental file core/jitopt.c will be selectively migrated into its master-branch counterpart core/jit_opt.c, and the experimental file core/jitopt.c will eventually be deleted. <a href="https://github.com/DynamoRIO/dynamorio/issues/3502">i#3502</a> tracks this work in the tracker.</p>
<h1><a class="anchor" id="autotoc_md186"></a>
Code Quality</h1>
<p>Please keep in mind that the student who wrote all of the code in this branch had less than 2 years of experience with the C language, and DynamoRIO is the only C project he had ever worked on (all of his experience was in Java&ndash;not even C++). While the code is functionally correct, it may exhibit some unusual structure, and certain annotative elements like const may be used incorrectly. There are also a few fragments of commented code, along with extensive "release
logging", most of which should probably not be committed to master in any form. If the logging is useful, it should be converted to use the standard DR logging mechanism, with a more formal provision for logging in release mode if necessary (since the Octane benchmarks take multiple days to run in a debug build of DR). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:02:58 &nbsp; <img border=0 src="favicon.png">
</small></address>
