---
title: "Function Wrapping and Replacing Extension"
layout: default
permalink: /page_drwrap.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Function Wrapping and Replacing Extension </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <code>drwrap</code> DynamoRIO Extension provides function wrapping and replacing support.</p>
<ul>
<li><a class="el" href="page_drwrap.html#sec_drwrap_setup">Setup</a></li>
<li><a class="el" href="page_drwrap.html#sec_drwrap_events">Event Replacement</a></li>
<li><a class="el" href="page_drwrap.html#sec_drwrap_api">API</a></li>
<li><a class="el" href="page_drwrap.html#sec_drwrap_perf">Performance</a></li>
<li><a class="el" href="page_drwrap.html#sec_drwrap_license">LGPL 2.1 License</a></li>
</ul>
<h1><a class="anchor" id="sec_drwrap_setup"></a>
Setup</h1>
<p>To use <code>drwrap</code> with your client simply include this line in your client's <code>CMakeLists.txt</code> file:</p>
<div class="fragment"><div class="line">use_DynamoRIO_extension(clientname drwrap) </div>
</div><!-- fragment --><p>That will automatically set up the include path and library dependence.</p>
<p>Initialize and clean up <code>drwrap</code> by calling <a class="el" href="group__drwrap.html#ga23837833101ebc340ac7de6e8340bb4a">drwrap_init()</a> and <a class="el" href="group__drwrap.html#ga0e58babc53301c4ade4027dc1e09a088">drwrap_exit()</a>.</p>
<h1><a class="anchor" id="sec_drwrap_events"></a>
Event Replacement</h1>
<p><code>drwrap</code> uses the <code>drmgr</code> Extension to ensure its events occur at the proper order. A user of <code>drwrap</code> must use the <code>drmgr</code> versions of the basic block and thread events.</p>
<h1><a class="anchor" id="sec_drwrap_api"></a>
API</h1>
<p>The first step in replacing or wrapping is to determine the address of the target application function. For functions exported by an application library, use <a class="el" href="dr__modules_8h.html#acb571b80307fd90538cb006725ab6183">dr_get_proc_address()</a> to locate the entry point. For internal functions, use the drsyms Extension (see <a class="el" href="page_drsyms.html">Symbol Access Library</a>).</p>
<p>Function replacing is provided by <a class="el" href="group__drwrap.html#ga488a6566cd760a3919bdd2f49a6d672f">drwrap_replace()</a>. The replacement function executes as application code and will be passed to the client via the basic block and trace events just like any other application code. The replaced function may still show up in the basic block event as a jump instruction; none of its actual code will execute. To avoid changing application behavior, ensure that the replacement function mirrors the calling convention and other semantics of the original function.</p>
<p>Function wrapping is provided by <a class="el" href="group__drwrap.html#ga4c004987daae07af15f2146c2d7d4b09">drwrap_wrap()</a>. A pre-function and/or post-function callback must be provided. The pre-function callback is invoked prior to every execution of the target function. The callback can examine and change function arguments and can skip the call to the target function (in which case there will be no post-function callback). The post-function callback can examine and change the target function's return value. Information (including copies of the arguments for examination in the post-function) can be passed between the pre- and post-functions via a user-controlled parameter.</p>
<p>Multiple wrap requests are allowed for one target function. Their callbacks are called sequentially in the reverse order of registration. If any pre-function callback asks to skip the function, the remaining pre-function callbacks will not be called, nor will any post-function callback.</p>
<p>The pre-function callback occurs at the beginning of the wrapped function, i.e., it executes after the <code>call</code> instruction but before any instructions within the body of the wrapped function. The post-function callback occurs after the wrapped function returns, as if inserted just after the call instruction.</p>
<h1><a class="anchor" id="sec_drwrap_perf"></a>
Performance</h1>
<p>For the lowest overhead, if your use case is compatible with the (relatively minor) limitations imposed by the two flags <a class="el" href="group__drwrap.html#ggab82c71baab4fe0c5f9962383818b9c92aeb299993e17993cb86912f93391f6b86">DRWRAP_NO_FRILLS</a> and <a class="el" href="group__drwrap.html#ggab82c71baab4fe0c5f9962383818b9c92add150e3e7ba4ee203a045b936f872b4b">DRWRAP_FAST_CLEANCALLS</a>, we recommend setting them both.</p>
<p>A major cause of overhead is flushing when a post-call point is dynamically discovered and it is already present in the code cache. The <a class="el" href="group__drwrap.html#gaff958909001824afeeaee334dc612e51">drwrap_get_stats()</a> interface can be used to measure the number of flushes triggered by drwrap.</p>
<h1><a class="anchor" id="sec_drwrap_license"></a>
LGPL 2.1 License</h1>
<p>The <code>drwrap</code> Extension is licensed under the LGPL 2.1 License and NOT the BSD license used for the rest of DynamoRIO. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:02:58 &nbsp; <img border=0 src="favicon.png">
</small></address>
